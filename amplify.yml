version: 1
backend:
  phases:
    build:
      commands:
        - cd backend
        - npm ci
        - npm run build
        - npm prune --production
        - cd ..
frontend:
  phases:
    preBuild:
      commands:
        - cd frontend
        - npm ci
    build:
      commands:
        - REACT_APP_PUBLIC_URL=/ npm run build
  artifacts:
    baseDirectory: frontend/build
    files:
      - '**/*'
  customHeaders:
    - pattern: '**/*'
      headers:
        - key: 'Cache-Control'
          value: 'public, max-age=3600, immutable'
    - pattern: '/*.html'
      headers:
        - key: 'Cache-Control'
          value: 'public, max-age=0, must-revalidate'
  cache:
    paths:
      - node_modules/**/*
  rewrites:
    - source: '</^(?!static|assets|images|favicon).*$>'
      target: '/index.html'
      status: '200'
  # Add redirects for API routes
  redirects:
    - source: '/api/<*>'
      target: '/index.html'
      status: '200'
    - source: '/api'
      target: '/index.html'
      status: '200' 